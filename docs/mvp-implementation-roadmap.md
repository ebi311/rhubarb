# 🗺️ MVP 実装ロードマップ

## 概要

このドキュメントは、MVP機能の実装順序と各フェーズの詳細を定義します。
優先度と依存関係を考慮し、段階的に価値を提供できる構成としています。

---

## 実装戦略の原則

1. **データ基盤から段階的に構築**: 基本データ → 表示 → 操作 → 高度機能
2. **早期にユーザー価値を提供**: フェーズ2でヘルパーへの核心価値を提供
3. **依存関係を最小化**: 各フェーズは可能な限り独立して完成可能
4. **テスト駆動**: 各機能は単体テストとストーリーブックを含む

---

## 📋 実装フェーズ

### フェーズ1: 基本スケジュール登録機能

**目的**: システムの基盤となるマスタデータと基本スケジュールの管理機能を実装

**ビジネス価値**:

- 管理者が現在の紙やExcelベースの情報をシステムに移行できる
- 以降の全機能の前提となるデータ基盤を構築

**含まれる機能**:

1. **利用者管理**
   - 利用者の一覧表示（テーブル形式、契約ステータスでフィルタリング可能）
   - 利用者の新規登録（デフォルトで契約中）
   - 利用者情報の編集（氏名、住所）
   - 契約の中断・再開（契約ステータス管理）
   - 必須項目: 氏名、住所（訪問先）
   - **注意**: 削除機能は提供しない（記録保持のため）

2. **担当許可リスト設定**
   - 利用者ごとに担当可能なスタッフを設定
   - サービス区分ごとの担当者アサイン
   - ホワイトリスト形式（設定されていないスタッフは担当不可）
   - UI: 利用者詳細画面内にマルチセレクト形式

3. **基本スケジュール登録**
   - 週間の繰り返しスケジュールを登録
   - 必須項目: 曜日、開始/終了時刻、利用者、サービス区分、デフォルト担当者
   - 一覧表示（曜日別、利用者別でフィルタリング可能）
   - 契約中の利用者のみ選択可能（中断中は選択不可）
   - CSVインポート機能（将来拡張として計画）

**技術要件**:

- マイグレーション: `add_contract_status_to_clients.sql`（完了済み）
- Repository層: `ClientRepository`, `ClientStaffAssignmentRepository`, `BasicScheduleRepository`
- UI Components: CRUD用のフォームとテーブル（daisyUI使用）
- バリデーション: Zod スキーマによる入力検証
- テスト: 各Repository、各Componentの単体テスト

**完了条件**:

- [ ] 利用者の一覧表示・新規登録・編集ができる
- [ ] 契約の中断・再開ができる
- [ ] 削除機能は存在しない
- [ ] 基本スケジュールが週間単位で登録できる
- [ ] 担当許可リストが設定できる
- [ ] 全てのCRUD操作に対するテストが通過

---

### フェーズ2: リアルタイム・マイカレンダー

**目的**: ヘルパーが自分のシフトを確認できる機能を実装

**ビジネス価値**:

- **「予定のすっぽかし」を防止** - MVP の核心価値の1つ
- ヘルパーが事務所に確認せずに最新のシフトを把握できる
- スマートフォンでいつでもアクセス可能

**含まれる機能**:

1. **シフト自動生成機能**
   - 基本スケジュール（BasicSchedule）から月次のシフト（Shift）を自動生成
   - 生成対象期間: 当月 + 翌月
   - ステータス: 初期値は「予定」
   - バッチ処理または管理者トリガー方式

2. **ヘルパー用カレンダー表示**
   - 週間ビュー（デフォルト）
   - 月間ビュー（切り替え可能）
   - 表示内容: 日時、利用者名、サービス内容、訪問先住所
   - レスポンシブデザイン（スマートフォン最適化）

3. **認証・認可の拡張**
   - ヘルパーロールの判定
   - 自分のシフトのみ表示（RLSポリシー拡張）
   - 管理者は全ヘルパーのシフトを閲覧可能

**技術要件**:

- Repository層: `ShiftRepository`（生成・取得ロジック）
- カレンダーライブラリ: Day.js for 日付操作、Cally or React Day Picker for UI
- RLS Policy: Shiftsテーブルに対するヘルパー制限
- バックエンドAPI: シフト生成エンドポイント

**完了条件**:

- [ ] 基本スケジュールから1ヶ月分のシフトが自動生成される
- [ ] ヘルパーが自分のシフトのみ閲覧できる
- [ ] 週間・月間の表示切り替えができる
- [ ] スマートフォンで快適に閲覧できる

---

### フェーズ3: 管理者向けビュー切り替え

**目的**: 管理者がスケジュール全体を多角的に把握できる機能を実装

**ビジネス価値**:

- 管理者が「誰が何をするか」と「どの利用者に誰が訪問するか」を瞬時に切り替えられる
- 変更調整時の判断材料を提供

**含まれる機能**:

1. **担当者（ヘルパー）ごとの表示**
   - ヘルパー別にシフトをグループ化して表示
   - カレンダー形式 or ガントチャート形式
   - 負荷状況の可視化（1日の稼働時間、週間合計時間）

2. **利用者ごとの表示**
   - 利用者別にシフトをグループ化して表示
   - どのヘルパーが担当しているかを一覧化
   - 未割当シフトの強調表示

3. **ビュー切り替えUI**
   - タブまたはトグルボタンで切り替え
   - フィルタリング機能（日付範囲、ヘルパー名、利用者名）
   - 検索機能

**技術要件**:

- フロントエンド: ビュー切り替えロジック、状態管理
- データ集約: Repository層でグループ化クエリ
- UI Components: フィルターコンポーネント、検索ボックス

**完了条件**:

- [ ] 担当者ごと/利用者ごとの表示切り替えができる
- [ ] フィルタリングと検索が機能する
- [ ] 未割当シフトが視覚的に目立つ

---

### フェーズ4: 変更登録機能

**目的**: 管理者が簡単にシフトを変更できる機能を実装

**ビジネス価値**:

- **「変更時の調整負担」を軽減** - MVP の核心価値の1つ
- イレギュラーな変更を迅速に反映できる

**含まれる機能**:

1. **シフトの手動変更**
   - 時間変更: 開始/終了時刻の編集
   - 担当者変更: ドロップダウンで別のヘルパーに変更
   - ステータス変更: 予定 → 確定 → 完了 → キャンセル
   - キャンセル処理: ワンクリックでキャンセル

2. **ドラッグ&ドロップUI**
   - シフトをドラッグして時間変更
   - 別のヘルパーの枠にドロップして担当者変更
   - ビジュアルフィードバック（ドラッグ中のプレビュー）

3. **バリデーション**
   - 担当許可リスト（ClientStaffAssignment）のチェック
   - 稼働可能シフト（StaffAvailability）のチェック
   - 重複チェック: 同一ヘルパーの同時刻シフト
   - エラーメッセージの表示

4. **変更履歴の記録**
   - 誰が、いつ、何を変更したかをログに記録
   - 監査証跡として保存

**技術要件**:

- ドラッグ&ドロップライブラリ: dnd-kit or react-beautiful-dnd
- バリデーションロジック: バックエンドAPI + フロントエンド即時検証
- 変更履歴テーブル: `ShiftChangeLog`（必要に応じて追加）

**完了条件**:

- [ ] シフトの時間、担当者、ステータスが変更できる
- [ ] ドラッグ&ドロップで直感的に操作できる
- [ ] 不正な変更は拒否され、理由が表示される
- [ ] 変更履歴が記録される

---

### フェーズ5: 変更の自動通知

**目的**: シフト変更時にヘルパーへ自動で通知する機能を実装

**ビジネス価値**:

- 管理者がヘルパーに個別連絡する手間をゼロにする
- 変更情報の伝達漏れを防止

**含まれる機能**:

1. **プッシュ通知の実装**
   - Web Push API による通知
   - 通知許可のリクエスト（初回ログイン時）
   - 通知内容: 変更されたシフトの概要（日時、利用者名、変更内容）

2. **変更時のトリガー処理**
   - シフト更新時に影響を受けるヘルパーを特定
   - バックグラウンドで通知を送信
   - 通知の送信履歴を記録

3. **通知設定**
   - ヘルパーが通知ON/OFFを設定できる
   - 通知方法の選択（将来的にメール、SMSも検討）

**技術要件**:

- Web Push API: Service Worker登録
- 通知サービス: Supabase Realtime or 外部サービス（Firebase Cloud Messaging等）
- バックエンド: 通知送信エンドポイント
- データベース: 通知設定テーブル、送信履歴テーブル

**完了条件**:

- [ ] シフト変更時にヘルパーにプッシュ通知が届く
- [ ] ヘルパーが通知設定を変更できる
- [ ] 通知の送信履歴が記録される

---

### フェーズ6: AI機能

**目的**: AI による変更調整支援機能を実装（差別化要素）

**ビジネス価値**:

- **最大の差別化要素**: 既存システムにない価値を提供
- 複雑な玉突き調整を短時間で完了できる
- 負荷の平準化をサポート

**含まれる機能**:

1. **AI代行者シミュレーション**
   - 欠員（キャンセル）シフトを選択
   - 以下の条件で代替ヘルパーを抽出:
     - 担当許可リスト（ClientStaffAssignment）に含まれる
     - 稼働可能シフト（StaffAvailability）の時間内
     - その時間帯に空きがある（重複していない）
   - 負荷が集中していない者を優先（月間総担当時間の少ない順）
   - 候補リストを表示（上位3〜5名）

2. **負荷バランサー警告**
   - 各ヘルパーの月間総担当時間を計算
   - 平均値から±20%以上逸脱する場合に警告表示
   - 警告メッセージ: 「○○さんの負荷が高くなっています」
   - 警告のみで自動修正はしない

3. **利用制限（フリープラン）**
   - AI代行者シミュレーション: 月5回まで
   - ヘルパー登録: 5名まで
   - 超過時は有料プランへの誘導メッセージ

4. **AI呼び出しの実装**
   - OpenAI API or Anthropic API の統合
   - プロンプトエンジニアリング: 条件を構造化して渡す
   - レスポンスのパース: 候補リストを抽出

**技術要件**:

- AI API: OpenAI GPT-4 or Anthropic Claude
- バックエンドAPI: AI呼び出しエンドポイント（認証・レート制限付き）
- 利用回数カウント: データベースに記録
- プラン管理: Subscriptionテーブル（将来拡張）

**完了条件**:

- [ ] 欠員シフトに対して代替ヘルパー候補が表示される
- [ ] 負荷が偏っている場合に警告が表示される
- [ ] フリープランの利用制限が機能する
- [ ] AI呼び出しのコストと速度が許容範囲内

---

## 🎯 最初の一歩: フェーズ1から開始

**推奨開始タスク**: 利用者管理画面

**理由**:

- サービス区分は既に固定マスタとして実装済み（マイグレーション + シードデータ）
- 最もシンプルで依存関係が少ない
- データ基盤を構築できる
- CRUD操作の実装パターンを確立できる（以降の機能に応用可能）
- 契約ステータス管理により誤ったスケジュール作成を防止

**次のアクション**:

1. 利用者管理の詳細機能仕様書を作成 ✅
2. シードデータの更新（契約中・中断中の両パターン）
3. 型定義とZodスキーマの作成
4. Repository層の実装開始（TDD）

---

## 📊 進捗管理

各フェーズの完了条件（チェックボックス）を使用して進捗を管理します。
全ての完了条件が満たされたフェーズは ✅ マークを付けます。

| フェーズ                        | ステータス | 完了予定 |
| :------------------------------ | :--------- | :------- |
| フェーズ1: 基本スケジュール登録 | 🔜 未着手  | -        |
| フェーズ2: マイカレンダー       | 🔜 未着手  | -        |
| フェーズ3: ビュー切り替え       | 🔜 未着手  | -        |
| フェーズ4: 変更登録             | 🔜 未着手  | -        |
| フェーズ5: 自動通知             | 🔜 未着手  | -        |
| フェーズ6: AI機能               | 🔜 未着手  | -        |

---

## 🔄 更新履歴

| 日付       | 変更内容 |
| :--------- | :------- |
| 2025-12-13 | 初版作成 |
