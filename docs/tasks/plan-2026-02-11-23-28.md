# 実装計画: 基本スケジュール（利用者グリッド）pillクリックをモーダル編集に変更

作成日: 2026-02-11 23:28

## 前提（ドラフト参照状況）

- 参照指定の Issue ドラフトは [docs/issues/issue-basic-schedule-grid-edit-in-modal.md](../issues/issue-basic-schedule-grid-edit-in-modal.md) に存在するが、現状ファイル内容が空だった。
- そのため本計画は、ユーザー提示の「要件（確定）」と「不明点の前提」を唯一の仕様として作成する。

## 要件（確定）

- viewMode=`grid` の「利用者グリッド」上で既存スケジュール(pill)をクリックした時、`/admin/basic-schedules/{id}/edit` へ遷移せず、追加スケジュールと同じダイアログで編集できる。
- ダイアログでは利用者(client)は変更不可。他の項目は変更可能。
- 既存の編集ページルート `/admin/basic-schedules/{id}/edit` は削除しない（直URLは維持）。

## 不明点の扱い（この計画の前提として明記）

- 保存/削除成功後はダイアログを閉じ、一覧を `router.refresh()` 等で反映する。
- 曜日変更は「利用者以外」に含まれるため変更可能（編集モーダルでは曜日固定しない）。
- 対象は viewMode=`grid` の pill のみ。他の viewMode（list / staff-grid）や一覧のリンク挙動は変更しない。

## 現状把握（関連実装）

- 利用者グリッドは [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.tsx)。
  - pill は `Link href=/admin/basic-schedules/{id}/edit`。
  - 追加は `AddButton` が `<dialog className="modal-open modal">` を出して `BasicScheduleForm asModal` を表示。
- 編集ページは [src/app/admin/basic-schedules/[id]/edit/page.tsx](../../src/app/admin/basic-schedules/[id]/edit/page.tsx)（維持要件あり）。
- データ取得 Action は [src/app/actions/basicSchedules.ts](../../src/app/actions/basicSchedules.ts) の `getBasicScheduleByIdAction`。
- フォームは [src/app/admin/basic-schedules/\_components/BasicScheduleForm/BasicScheduleForm.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.tsx)。
  - `fixedClientId` が指定されると利用者は読み取り専用表示になり要件に合う。
  - `onSubmitSuccess` が指定されると成功後に `router.push('/admin/basic-schedules')` ではなくコールバックが呼ばれる（モーダル close に使える）。
  - ただし削除フローは [src/app/admin/basic-schedules/\_components/BasicScheduleForm/useDeleteSchedule.ts](../../src/app/admin/basic-schedules/_components/BasicScheduleForm/useDeleteSchedule.ts) が常に `router.push('/admin/basic-schedules')` を行うため、モーダル要件と衝突する。

## 影響範囲（ファイル一覧）

最小想定（+テスト/Storybook 含む）:

- [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.tsx)
- [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/AddButton.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/AddButton.tsx)（必要なら refresh 反映の共通化）
- [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.test.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.test.tsx)
- [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.stories.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.stories.tsx)
- [src/app/admin/basic-schedules/\_components/BasicScheduleForm/useDeleteSchedule.ts](../../src/app/admin/basic-schedules/_components/BasicScheduleForm/useDeleteSchedule.ts)
- [src/app/admin/basic-schedules/\_components/BasicScheduleForm/BasicScheduleForm.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.tsx)（削除コールバックの受け渡しが必要な場合）
- （任意・重複削減）初期値変換を共通化する場合:
  - [src/app/admin/basic-schedules/[id]/edit/page.tsx](../../src/app/admin/basic-schedules/[id]/edit/page.tsx)
  - 新規: `src/app/admin/basic-schedules/_components/BasicScheduleForm/toFormInitialValues.ts` 等

## 具体設計

### 1) どこに dialog を置くか

- 追加スケジュールと同じ UX に寄せるため、既存の `AddButton` と同様に「利用者グリッド内（BasicScheduleGrid）」に `<dialog>` を配置する。
- 実装は 2案。

**案A（最小変更・推奨）: BasicScheduleGrid に編集用 dialog 状態を追加**

- [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.tsx) を `'use client'` 化。
- state:
  - `editingScheduleId: string | null`
  - `isEditModalOpen: boolean`
  - `editInitialValues: BasicScheduleFormInitialValues | null`
  - `fixedClient: { id: string; name: string } | null`
  - `isLoading: boolean`（モーダル内表示用）
- pill クリック:
  1. `editingScheduleId` をセットしモーダル open
  2. `getBasicScheduleByIdAction(id)` を呼ぶ
  3. 成功なら `editInitialValues` と `fixedClient` をセット
  4. 失敗ならトースト表示（`useActionResultHandler` を利用）しモーダル close

**案B（整理重視）: EditScheduleDialog コンポーネントを新設**

- `BasicScheduleGrid` は presentational に寄せ、編集 dialog のロジックを `EditScheduleDialog`（client component）へ分離。
- 変更ファイル数が増えるため、要件が固い今回は案Aを優先。

### 2) 状態管理（開閉とクリア）

- open:
  - クリックで `isEditModalOpen=true`。
  - `editInitialValues` がない間は「読み込み中…」を表示。
- close:
  - `handleCloseEditModal()` で state を全クリア（`editingScheduleId`/`editInitialValues`/`fixedClient`/`isLoading`）。
- 保存/削除成功:
  - 前提どおり `handleCloseEditModal(); router.refresh();` を実行。

### 3) データ取得方法（getBasicScheduleByIdAction の呼び方）

- クライアントイベント（pill click）から `await getBasicScheduleByIdAction(scheduleId)` を直接呼ぶ。
  - Next.js の Server Action は Client Component のイベントハンドラから呼べる（Next.js 公式 docs の “Updating Data” に沿う）。
- 取得した `BasicScheduleRecord` を `BasicScheduleFormInitialValues` に変換:
  - `start_time`/`end_time` を `HH:MM` に整形
  - `serviceTypeId`, `weekday`, `note`, `staffId(単一)` をセット
- 重複排除（任意）:
  - edit page の `toFormInitialValues` と同じ変換が必要なので、変換関数を `BasicScheduleForm` 配下へ切り出し、編集ページもそれを使用する（テストしやすい）。

### 4) ダイアログ内フォームの構成

- `<dialog className="modal-open modal">` + `<div className="modal-box">` の骨格は `AddButton` と揃える。
- `BasicScheduleForm` 呼び出し（edit）:
  - `mode="edit"`
  - `scheduleId={editingScheduleId}`
  - `initialValues={editInitialValues}`
  - `fixedClientId={fixedClient.id}`（利用者変更不可を担保）
  - `fixedWeekday` は **渡さない**（曜日変更可能）
  - `asModal`
  - `onSubmitSuccess={() => { close; router.refresh(); }}`
  - `onCancel={close}`

### 5) 削除フローの調整（必須）

- 現状 `useDeleteSchedule` は成功後に `router.push('/admin/basic-schedules')` 固定。
- 変更方針:
  - `useDeleteSchedule({ scheduleId, onDeleteSuccess? })` を追加。
  - `onDeleteSuccess` がある場合はそれを呼び、ない場合は従来通り `router.push('/admin/basic-schedules')`。
- `BasicScheduleForm` 側は、モーダル利用時に `onSubmitSuccess` と同等の callback を `useDeleteSchedule` に渡せるようにする（Props を 1つ増やす or `onSubmitSuccess` を転用）。

### 6) 既存編集ページ（直URL）の維持

- `/admin/basic-schedules/[id]/edit/page.tsx` は残す。
- grid pill は Link を廃止し、ボタン/クリックハンドラに置き換えることで要件を満たす。

## TDD 方針（追加/更新するテスト）

### ユニット/コンポーネントテスト

- 更新: [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.test.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.test.tsx)
  - 「スケジュールセルがリンクになっている」テストは仕様変更により置き換え。
  - 追加するテスト案:
    1. pill をクリックすると編集ダイアログが開く（`role=dialog` とタイトル文言）
    2. `getBasicScheduleByIdAction` が指定 id で呼ばれる（`vi.mock` で監視）
    3. 取得後、利用者フィールドが read-only 表示になる（利用者 select が出ない / ClientReadOnlyField が出る）
    4. `onSubmitSuccess` 相当の callback で close + `router.refresh` が呼ばれる（`useRouter().refresh` をモック）
- 追加/更新: `useDeleteSchedule` の振る舞い
  - 既存のテストがないため、可能なら `BasicScheduleForm.test.tsx` に統合テストとして追加。
  - テスト案: `onDeleteSuccess` を渡した場合、削除成功時に push せず callback が呼ばれる。

### Storybook

- 更新: [src/app/admin/basic-schedules/\_components/BasicScheduleGrid/BasicScheduleGrid.stories.tsx](../../src/app/admin/basic-schedules/_components/BasicScheduleGrid/BasicScheduleGrid.stories.tsx)
  - pill クリックが server action を呼ぶようになるため、Storybook でのエラー回避が必要。
  - 対応案（いずれか）:
    - Storybook 側で `getBasicScheduleByIdAction` をモックして固定データを返す（推奨: プロジェクトの既存 Storybook モック手法に合わせる）
    - クリック時に fetch 失敗した場合はモーダルを閉じる実装にして Storybook でも破綻しないようにする（UX追加は最小の範囲で）

## フェーズ分割（5ファイル超のため分割推奨）

### Phase 1: 下準備（削除コールバック対応）

- `useDeleteSchedule` に `onDeleteSuccess` を追加
- `BasicScheduleForm` から `useDeleteSchedule` へ callback を渡せるように調整
- 関連テストを追加/更新

### Phase 2: グリッド pill のモーダル編集

- `BasicScheduleGrid` を `'use client'` 化し、pill を Link → button に変更
- `getBasicScheduleByIdAction` 呼び出し + 初期値変換 + edit dialog 表示
- 保存/削除成功時: close + `router.refresh()`
- BasicScheduleGrid のテストを更新

### Phase 3: Storybook/仕上げ

- BasicScheduleGrid story の破綻回避（モック or 最小の失敗時挙動）
- 目視確認（grid / 他 viewMode / 直URL edit ページ）

## 成果物（PR 粒度・レビュー観点）

### PR1（小さめ・安全）: 削除成功後の遷移をコールバック化

- 変更点: `useDeleteSchedule` 拡張、`BasicScheduleForm` 受け渡し、テスト追加
- レビュー観点:
  - 既存の編集ページで削除→一覧遷移が維持されているか
  - `onDeleteSuccess` 指定時に push が抑制されるか

### PR2（要件本丸）: 利用者グリッド pill 編集をモーダル化

- 変更点: BasicScheduleGrid の UI/状態/データ取得、テスト更新、(必要なら) Storybook
- レビュー観点:
  - grid pill クリックで遷移しないこと（他 viewMode は不変）
  - モーダル内で利用者が変更不可であること
  - 曜日が変更可能であること
  - 保存/削除後に close + refresh され表示が更新されること
  - 直URL `/admin/basic-schedules/{id}/edit` が引き続き動くこと

## 実装後の確認項目（手動）

- viewMode=grid:
  - pill クリック→編集モーダル
  - 保存→閉じる→一覧に反映
  - 削除→閉じる→一覧に反映
- viewMode=list / staff-grid:
  - 既存どおり edit ページへ遷移
- 直URL:
  - `/admin/basic-schedules/{id}/edit` が編集でき、保存後の挙動が従来通り
