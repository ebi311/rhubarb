# Issue #10: ダッシュボードのアラート表示を改善

## 概要

ダッシュボードの「注意が必要な予定」（アラート）において、以下の機能を追加する：

1. **日付表示**: 各アラートに `M/D` 形式で日付を表示
2. **週次スケジュール画面への遷移**: クリックすると該当週の週次スケジュール画面に遷移

## 対象ファイル

- `src/app/_components/DashboardAlerts/DashboardAlerts.tsx`
- `src/app/_components/DashboardAlerts/DashboardAlerts.test.tsx`
- `src/app/_components/DashboardAlerts/DashboardAlerts.stories.tsx`

## 技術調査結果

### 既存実装

- `AlertItemSchema` には既に `date` フィールドがある（`z.coerce.date()`）
- 週次スケジュール画面は `/admin/weekly-schedules?week=YYYY-MM-DD` 形式
- `getMonday()` 関数が `src/app/admin/weekly-schedules/helpers.ts` に存在
- `dateJst()` ユーティリティで JST タイムゾーンの dayjs オブジェクトを取得可能

### アクセシビリティ考慮事項

WAI-ARIA 仕様によると、`role="alert"` はテキストコンテンツにのみ使用すべきで、リンクやボタンなどのインタラクティブ要素には **推奨されない**。

**解決策**: アラート全体を `<Link>` コンポーネントでラップし、内部に alert のスタイリングを適用。`role="alert"` を削除し、代わりに `aria-label` でスクリーンリーダー向けの情報を提供する。

## 実装計画

### フェーズ1: テストの作成（TDD）

#### 1.1 ユニットテスト追加 (`DashboardAlerts.test.tsx`)

**新規テストケース:**

```typescript
describe('日付表示', () => {
	it('各アラートに月日が M/D 形式で表示される', () => {
		// 2026-02-03 → "2/3"
		// 2026-02-04 → "2/4"
	});
});

describe('週次スケジュールへの遷移', () => {
	it('各アラートが週次スケジュールへのリンクを持つ', () => {
		// href が /admin/weekly-schedules?week=YYYY-MM-DD 形式であること
	});

	it('リンクの week パラメータが該当週の月曜日である', () => {
		// 2026-02-03（火曜日）→ week=2026-02-02（月曜日）
		// 2026-02-04（水曜日）→ week=2026-02-02（月曜日）
	});

	it('アクセシブルなラベルが設定されている', () => {
		// aria-label に日付、クライアント名、時刻が含まれること
	});
});
```

### フェーズ2: コンポーネント実装

#### 2.1 ヘルパー関数の追加

`DashboardAlerts.tsx` に週の開始日を計算する内部関数を追加（または既存の `getMonday` をインポート）:

```typescript
import { getMonday } from '@/app/admin/weekly-schedules/helpers';
import { dateJst } from '@/utils/date';
import Link from 'next/link';
```

#### 2.2 日付フォーマット関数

```typescript
// M/D 形式に変換
const formatDateMD = (date: Date): string => {
	return dateJst(date).format('M/D');
};
```

#### 2.3 遷移URL生成関数

```typescript
// 週次スケジュール画面へのURL生成
const getWeeklyScheduleUrl = (date: Date): string => {
	const monday = getMonday(date);
	const weekParam = dateJst(monday).format('YYYY-MM-DD');
	return `/admin/weekly-schedules?week=${weekParam}`;
};
```

#### 2.4 コンポーネント構造変更

**変更前:**

```tsx
<div role="alert" className="alert ...">
  <Icon ... />
  <div>
    <div className="font-bold">{clientName} - {time}</div>
    <div className="text-sm">{message}</div>
  </div>
</div>
```

**変更後:**

```tsx
<Link
  href={getWeeklyScheduleUrl(alert.date)}
  aria-label={`${formatDateMD(alert.date)} ${alert.clientName} ${timeObjectToString(alert.startTime)} ${alert.message} 週次スケジュールを開く`}
  className={`alert ${alertColorClass} hover:opacity-80 transition-opacity`}
>
  <Icon ... />
  <div>
    <div className="font-bold">
      {formatDateMD(alert.date)} {alert.clientName} - {timeObjectToString(alert.startTime)}
    </div>
    <div className="text-sm">{message}</div>
  </div>
</Link>
```

**構造のポイント:**

- `role="alert"` を削除（Link 要素内では非推奨）
- `<Link>` に daisyUI の `alert` クラスを適用
- `hover:opacity-80` でホバー時のインタラクションフィードバック
- `aria-label` でアクセシビリティを確保

### フェーズ3: Storybook 更新

#### 3.1 ストーリー説明の更新

```typescript
/**
 * 日付付きアラート（クリックで週次スケジュールに遷移）
 */
export const Default: Story = { ... };
```

#### 3.2 異なる週のテストデータ追加

```typescript
// 異なる週にまたがるアラート
const crossWeekAlerts: AlertItem[] = [
  { date: new Date('2026-02-02'), ... }, // 2/2週
  { date: new Date('2026-02-09'), ... }, // 2/9週
];

export const CrossWeekAlerts: Story = {
  args: { alerts: crossWeekAlerts },
};
```

### フェーズ4: 検証

1. ユニットテスト実行: `pnpm test:ut --run`
2. Storybook 確認: `pnpm storybook`
3. E2E 手動確認:
   - アラートをクリックして週次スケジュール画面に遷移するか
   - URL の `week` パラメータが正しい月曜日か

## タスクチェックリスト

- [ ] `DashboardAlerts.test.tsx` に日付表示のテスト追加
- [ ] `DashboardAlerts.test.tsx` にリンク遷移のテスト追加
- [ ] `DashboardAlerts.tsx` に `formatDateMD` 関数追加
- [ ] `DashboardAlerts.tsx` に `getWeeklyScheduleUrl` 関数追加
- [ ] `DashboardAlerts.tsx` のアラートを Link でラップ
- [ ] アクセシビリティ属性（`aria-label`）追加
- [ ] ホバースタイル追加
- [ ] `DashboardAlerts.stories.tsx` を更新
- [ ] ユニットテスト実行・通過確認
- [ ] Storybook 動作確認

## 予想作業時間

- テスト作成: 20分
- コンポーネント実装: 30分
- Storybook 更新: 10分
- 検証・調整: 15分

**合計: 約1時間15分**

## 注意事項

1. **TDD アプローチ**: テストを先に書き、失敗を確認してから実装
2. **Arrow Function**: すべての関数は Arrow Function で記述
3. **getMonday 関数の再利用**: 既存の `helpers.ts` からインポート
4. **ロールの削除**: `role="alert"` はインタラクティブ要素では非推奨のため削除

## 参考リソース

- [WAI-ARIA: alert role](https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA/Reference/Roles/alert_role)
- 既存実装: `src/app/_components/DashboardQuickAccess/DashboardQuickAccess.tsx`
- 週の開始日計算: `src/app/admin/weekly-schedules/helpers.ts`
