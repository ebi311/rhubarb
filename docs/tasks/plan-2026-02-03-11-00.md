# ダッシュボード画面の機能拡張 実装計画

- **Issue**: [#2 ダッシュボード画面の機能拡張](https://github.com/ebi311/rhubarb/issues/2)
- **作成日**: 2026-02-03
- **ブランチ**: `feature/issue-2-dashboard-enhancement`

## 概要

    const request = new NextRequest("http://localhost:3000/api/`/`）をダッシュボードとして機能拡充し、管理者が朝一番に確認したい情報を一画面で把握できるようにする。{\

## 機能要件

| 機能               | 説明                            | daisyUIコンポーネント |
| ------------------ | ------------------------------- | --------------------- |
| 統計カード         | 今日/今週の予定件数、未割当件数 | `stats`               |
| 今日のタイムライン | 本日のスケジュールを時系列表示  | `timeline`            |
| アラートセクション | 未割当・欠員の予定一覧          | `alert`               |

## アーキテクチャ

# const request = new NextRequest("http://localhost:3000/api/Clients", {\

    const request = new NextRequest("http://localhost:3000/api/clients", {\

```
[Server Actions] → [Service] → [Repository] → [Supabase]
src/app/actions/dashboard.ts → src/backend/services/dashboardService.ts → ShiftRepository
```

## ファイル構成

### 1. バックエンド層

| ファイル                                        | 説明                               |
| ----------------------------------------------- | ---------------------------------- |
| `src/backend/services/dashboardService.ts`      | ダッシュボード用データ集計ロジック |
| `src/backend/services/dashboardService.test.ts` | Serviceのユニットテスト            |
| `src/app/actions/dashboard.ts`                  | Server Actions                     |
| `src/app/actions/dashboard.test.ts`             | Actionsのユニットテスト            |
| `src/models/dashboardActionSchemas.ts`          | 入出力Zodスキーマ                  |

### 2. フロントエンド層

```
src/app/_components/Dashboard/
 Dashboard.tsx
 Dashboard.test.tsx
 Dashboard.stories.tsx
 index.ts
 DashboardStats/
   ├── DashboardStats.tsx
   ├── DashboardStats.test.tsx
   ├── DashboardStats.stories.tsx
   └── index.ts
 TodayTimeline/
   ├── TodayTimeline.tsx
   ├── TodayTimeline.test.tsx
   ├── TodayTimeline.stories.tsx
   └── index.ts
 AlertSection/
    ├── AlertSection.tsx
    ├── AlertSection.test.tsx
    ├── AlertSection.stories.tsx
    └── index.ts
```

### 3. ページ更新

| ファイル                | 変更内容                          |
| ----------------------- | --------------------------------- |
| `src/app/page.tsx`      | Dashboardコンポーネントの組み込み |
| `src/app/page.test.tsx` | テストの更新                      |

## データ型定義

### DashboardStats (統計データ)

```typescript
interface DashboardStats {
	todayShiftCount: number; // 今日の予定件数
	weekShiftCount: number; // 今週の予定件数
	unassignedCount: number; // 未割当件数
}
```

### TodayTimelineItem (タイムラインアイテム)

```typescript
interface TodayTimelineItem {
	id: string;
	startTime: { hour: number; minute: number };
	endTime: { hour: number; minute: number };
	clientName: string;
	staffName: string | null; // 未割当の場合はnull
	isUnassigned: boolean;
	serviceTypeName: string;
}
```

### AlertItem (アラートアイテム)

```typescript
interface AlertItem {
	id: string;
	type: 'unassigned' | 'shortage';
	date: Date;
	startTime: { hour: number; minute: number };
	clientName: string;
	message: string;
}
```

## 実装順序（TDDアプローチ）

### Phase 1: スキーマとサービス層 (バックエンド)

1. **[1-1] dashboardActionSchemas.ts を作成**
   - `DashboardStatsSchema`
   - `TodayTimelineItemSchema`
   - `AlertItemSchema`
   - `DashboardDataSchema` (統合型)

2. **[1-2] dashboardService.test.ts を作成**
   - `getDashboardStats()` のテストを先に書く
   - `getTodayTimeline()` のテストを先に書く
   - `getAlerts()` のテストを先に書く

3. **[1-3] dashboardService.ts を実装**
   - 既存の `ShiftRepository` を活用
   - 必要に応じて `ServiceUserRepository` からクライアント名を取得
   - 必要に応じて `StaffRepository` からスタッフ名を取得

4. **[1-4] dashboard.test.ts (Actions) を作成**
   - `getDashboardDataAction()` のテスト

5. **[1-5] dashboard.ts (Actions) を実装**
   - 認証チェック
   - Service呼び出し
   - ActionResult返却

### Phase 2: UIコンポーネント (フロントエンド)

6. **[2-1] DashboardStats コンポーネント**
   - テスト作成 (`DashboardStats.test.tsx`)
   - 実装 (`DashboardStats.tsx`) - daisyUI `stats` 使用
   - Storybook作成 (`DashboardStats.stories.tsx`)

7. **[2-2] TodayTimeline コンポーネント**
   - テスト作成 (`TodayTimeline.test.tsx`)
   - 実装 (`TodayTimeline.tsx`) - daisyUI `timeline` 使用
   - Storybook作成 (`TodayTimeline.stories.tsx`)

8. **[2-3] AlertSection コンポーネント**
   - テスト作成 (`AlertSection.test.tsx`)
   - 実装 (`AlertSection.tsx`) - daisyUI `alert` 使用
   - Storybook作成 (`AlertSection.stories.tsx`)

9. **[2-4] Dashboard コンポーネント (統合)**
   - テスト作成 (`Dashboard.test.tsx`)
   - 実装 (`Dashboard.tsx`) - 子コンポーネントを組み合わせ
   - Storybook作成 (`Dashboard.stories.tsx`)

### Phase 3: ページ統合

10. **[3-1] page.tsx の更新**
    - Dashboardコンポーネントの組み込み
    - Suspenseによるローディング状態対応
    - page.test.tsx の更新

## UIコンポーネント設計

### DashboardStats

```tsx
// daisyUI stats コンポーネント使用
<div class="stats stats-vertical shadow lg:stats-horizontal">
	<div class="stat">
		<div class="stat-title">今日の予定</div>
		<div class="stat-value">{todayShiftCount}</div>
		<div class="stat-desc">件</div>
	</div>
	<div class="stat">
		<div class="stat-title">今週の予定</div>
		<div class="stat-value">{weekShiftCount}</div>
		<div class="stat-desc">件</div>
	</div>
	<div class="stat">
		<div class="stat-title">未割当</div>
		<div class="stat-value text-warning">{unassignedCount}</div>
		<div class="stat-desc">対応が必要</div>
	</div>
</div>
```

### TodayTimeline

```tsx
// daisyUI timeline コンポーネント使用
<ul class="timeline timeline-vertical">
	{items.map((item) => (
		<li key={item.id}>
			<div class="timeline-start">{formatTime(item.startTime)}</div>
			<div class="timeline-middle">
				<svg>...</svg>
			</div>
			<div
				class={cn(
					'timeline-end timeline-box',
					item.isUnassigned && 'border-warning',
				)}
			>
				<p>{item.clientName}</p>
				<p class="text-sm">{item.staffName ?? '未割当'}</p>
			</div>
		</li>
	))}
</ul>
```

### AlertSection

```tsx
// daisyUI alert コンポーネント使用
<div class="space-y-2">
	{alerts.length === 0 ? (
		<div class="alert alert-success">
			<span>対応が必要な項目はありません</span>
		</div>
	) : (
		alerts.map((alert) => (
			<div key={alert.id} class="alert alert-warning">
				<svg>...</svg>
				<span>{alert.message}</span>
			</div>
		))
	)}
</div>
```

## レスポンシブデザイン

| ブレークポイント     | レイアウト                              |
| -------------------- | --------------------------------------- |
| モバイル (`< sm`)    | 統計カード縦並び、タイムライン全幅      |
| タブレット (`sm-lg`) | 統計カード横並び、2カラム               |
| デスクトップ (`lg+`) | 統計カード横並び、サイドバー付き3カラム |

```tsx
<div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
	<div className="lg:col-span-2">
		<DashboardStats />
		<TodayTimeline />
	</div>
	<div className="lg:col-span-1">
		<AlertSection />
	</div>
</div>
```

## テスト戦略

### ユニットテスト (Vitest + Testing Library)

| 対象             | テスト内容                                    |
| ---------------- | --------------------------------------------- |
| DashboardService | データ集計ロジック、日付計算                  |
| DashboardStats   | Propsに応じた表示確認                         |
| TodayTimeline    | 空データ/複数データの表示、未割当のハイライト |
| AlertSection     | アラートなし/あり時の表示                     |
| Dashboard        | 子コンポーネントの統合                        |

### Storybookストーリー

| ストーリー     | 説明             |
| -------------- | ---------------- |
| Default        | 通常状態         |
| NoShifts       | 予定なし         |
| WithUnassigned | 未割当あり       |
| Loading        | ローディング状態 |

## 依存関係

### 既存リソースの活用

- `ShiftRepository`: シフトデータ取得
- `ServiceUserRepository`: 利用者名取得
- `StaffRepository`: スタッフ名取得
- `setJstTime`, `getJstDateOnly`: 日付処理ユーティリティ

### 新規追加不要

- Supabaseテーブル: 既存の `shifts`, `clients`, `staffs` を使用
- マイグレーション: 不要

## 見積もり

| フェーズ                  | 作業時間目安 |
| ------------------------- | ------------ |
| Phase 1: バックエンド     | 2-3時間      |
| Phase 2: UIコンポーネント | 3-4時間      |
| Phase 3: ページ統合       | 1時間        |
| **合計**                  | **6-8時間**  |

## チェックリスト

- [ ] ブランチ作成: `feature/issue-2-dashboard-enhancement`
- [ ] Phase 1: dashboardActionSchemas.ts
- [ ] Phase 1: dashboardService.test.ts / dashboardService.ts
- [ ] Phase 1: dashboard.test.ts / dashboard.ts
- [ ] Phase 2: DashboardStats (テスト → 実装 → Storybook)
- [ ] Phase 2: TodayTimeline (テスト → 実装 → Storybook)
- [ ] Phase 2: AlertSection (テスト → 実装 → Storybook)
- [ ] Phase 2: Dashboard (テスト → 実装 → Storybook)
- [ ] Phase 3: page.tsx 更新
- [ ] レスポンシブ確認 (モバイル/タブレット/デスクトップ)
- [ ] `pnpm format` 実行
- [ ] `pnpm test:ut --run` 全テストパス
- [ ] `pnpm test:storybook` 全テストパス
- [ ] PRレビュー依頼

## 参考資料

- [docs/MVP.md](../MVP.md) - 要件1：予定の一元化と見える化
- [docs/screens/README.md](../screens/README.md) - 画面設計
- [daisyUI stats](https://daisyui.com/components/stats/)
- [daisyUI timeline](https://daisyui.com/components/timeline/)
- [daisyUI alert](https://daisyui.com/components/alert/)
