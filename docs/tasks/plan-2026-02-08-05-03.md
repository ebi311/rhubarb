# Issue #23: 基本スケジュール複数予定登録 実装計画

## 概要

\1週間分の予定をまとめて登録・変更できる機能を実装する。

## 現状分析

### 既存実装

| 項目           | 現状                                                             |
| -------------- | ---------------------------------------------------------------- |
| 登録フォーム   | `BasicScheduleForm` - 1件ずつ登録/編集                           |
| グリッド表示   | `BasicScheduleGrid` - 利用者×曜日のビュー（読取専用）            |
| Server Actions | 単件操作のみ（create, update, delete）                           |
| URL構成        | `/admin/basic-schedules/new`, `/admin/basic-schedules/[id]/edit` |

### 今回追加すべき機能

1. **利用者別一括編集画面** - 特定利用者の1週間分スケジュールを編集
2. **バッチ Server Action** - 複数スケジュールの一括保存
3. **状態管理** - 追加・変更・削除を追跡する useReducer
4. **未保存警告** - ページ離脱時の確認ダイアログ

---

## アーキテクチャ設計

### URL構成

| URL                                              | 用途                   |
| ------------------------------------------------ | ---------------------- |
| `/admin/basic-schedules/new/[clientId]`          | 新規登録（利用者指定） |
| `/admin/basic-schedules/clients/[clientId]/edit` | 一括編集               |

### コンポーネント構成

```
src/app/admin/basic-schedules/
 clients/
   └── [clientId]/
       └── edit/
           └── page.tsx              # 編集ページ（Server Component）
 new/
   └── [clientId]/
       └── page.tsx                  # 新規登録ページ（利用者別）
 _components/
    └── ClientScheduleEditor/
        ├── ClientScheduleEditor.tsx  # メインコンテナ
        ├── WeeklyScheduleGrid/       # 曜日グリッド表示
        ├── ScheduleEntryForm/        # 予定追加/編集フォーム
        ├── useScheduleReducer/       # 状態管理Hook
        ├── useBeforeUnload/          # 未保存警告Hook
        └── types.ts
```

### 状態管理（useReducer）

```typescript
// 状態の型定義
type ScheduleEntryStatus = 'unchanged' | 'added' | 'modified' | 'deleted';

type ScheduleEntry = {
	id: string; // 新規は一時ID（UUID）
	tempId?: string; // 新規追加時の識別子
	originalId?: string; // 既存データのID
	weekday: DayOfWeek;
	startTime: TimeValue;
	endTime: TimeValue;
	serviceTypeId: string;
	staffIds: string[];
	note: string | null;
	status: ScheduleEntryStatus;
};

type EditorState = {
	entries: ScheduleEntry[];
	editingEntry: ScheduleEntry | null;
	isFormOpen: boolean;
};

// アクション
type EditorAction =
	| { type: 'INIT'; payload: ScheduleEntry[] }
	| { type: 'ADD_ENTRY'; payload: Omit<ScheduleEntry, 'id' | 'status'> }
	| {
			type: 'UPDATE_ENTRY';
			payload: { id: string; data: Partial<ScheduleEntry> };
	  }
	| { type: 'DELETE_ENTRY'; payload: string }
	| { type: 'OPEN_FORM'; payload?: ScheduleEntry }
	| { type: 'CLOSE_FORM' }
	| { type: 'RESET' };
```

### データフロー

```
[Initial Load] → サーバーから既存データ取得
                         ↓
[useScheduleReducer] ← entries 初期化
                         ↓
[WeeklyScheduleGrid] ← 曜日別にグループ化して表示
                         ↓
[ScheduleEntryForm] → 追加/編集 → dispatch(ADD/UPDATE)
                         ↓
[確定ボタン] → 差分計算 → batchUpsertBasicSchedulesAction
```

---

## ファイル詳細設計

### 1. Zod スキーマ追加 (`src/models/basicScheduleActionSchemas.ts`)

```typescript
// バッチ操作用スキーマ
export const BatchScheduleOperationSchema = z.object({
	create: z.array(BasicScheduleInputSchema),
	update: z.array(
		z.object({
			id: z.uuid(),
			data: BasicScheduleInputSchema.partial(),
		}),
	),
	delete: z.array(z.uuid()),
});

export type BatchScheduleOperation = z.infer<
	typeof BatchScheduleOperationSchema
>;

export const BatchScheduleResultSchema = z.object({
	created: z.number(),
	updated: z.number(),
	deleted: z.number(),
	errors: z
		.array(
			z.object({
				operation: z.enum(['create', 'update', 'delete']),
				index: z.number(),
				message: z.string(),
			}),
		)
		.optional(),
});

export type BatchScheduleResult = z.infer<typeof BatchScheduleResultSchema>;
```

### 2. Repository 拡張 (`src/backend/repositories/basicScheduleRepository.ts`)

```typescript
// 追加メソッド
async listByClientId(clientId: string): Promise<BasicScheduleWithStaff[]>;

async batchCreate(
  schedules: Array<{ schedule: BasicSchedule; staffIds: string[] }>
): Promise<void>;

async batchUpdate(
  updates: Array<{ schedule: BasicSchedule; staffIds: string[] }>
): Promise<void>;

async batchSoftDelete(ids: string[], deletedAt: Date): Promise<void>;
```

### 3. Service 拡張 (`src/backend/services/basicScheduleService.ts`)

```typescript
// 追加メソッド
async listByClientId(
  userId: string,
  clientId: string
): Promise<BasicScheduleRecord[]>;

async batchUpsert(
  userId: string,
  clientId: string,
  operations: BatchScheduleOperation
): Promise<BatchScheduleResult>;
```

### 4. Server Action 追加 (`src/app/actions/basicSchedules.ts`)

```typescript
export const listBasicSchedulesByClientAction = async (
  clientId: string
): Promise<ActionResult<BasicScheduleRecord[]>>;

export const batchUpsertBasicSchedulesAction = async (
  clientId: string,
  operations: BatchScheduleOperation
): Promise<ActionResult<BatchScheduleResult>>;
```

### 5. UIコンポーネント

#### `ClientScheduleEditor/`

| ファイル                           | 説明                               |
| ---------------------------------- | ---------------------------------- |
| `ClientScheduleEditor.tsx`         | メインコンテナ（コンテキスト提供） |
| `ClientScheduleEditor.test.tsx`    | 統合テスト                         |
| `ClientScheduleEditor.stories.tsx` | Storybook                          |
| `index.ts`                         | エクスポート                       |

#### `WeeklyScheduleGrid/`

| ファイル                 | 説明                                           |
| ------------------------ | ---------------------------------------------- |
| `WeeklyScheduleGrid.tsx` | 曜日×時間帯グリッド                            |
| `ScheduleCard.tsx`       | 各予定のカード（ステータスインジケーター付き） |
| `types.ts`               | グリッド用型定義                               |

#### `ScheduleEntryForm/`

| ファイル                  | 説明                                |
| ------------------------- | ----------------------------------- |
| `ScheduleEntryForm.tsx`   | モーダルフォーム（react-hook-form） |
| `useScheduleEntryForm.ts` | フォームロジック                    |

#### `useScheduleReducer/`

| ファイル                | 説明                  |
| ----------------------- | --------------------- |
| `useScheduleReducer.ts` | メインHook            |
| `reducer.ts`            | Reducer関数           |
| `types.ts`              | State/Action型        |
| `reducer.test.ts`       | Reducerユニットテスト |

#### `useBeforeUnload/`

| ファイル                  | 説明               |
| ------------------------- | ------------------ |
| `useBeforeUnload.ts`      | ページ離脱警告Hook |
| `useBeforeUnload.test.ts` | ユニットテスト     |

---

## TDD実装順序

### Phase 1: バックエンド拡張（2-3時間）

1. **Zodスキーマ追加**
   - [ ] `BatchScheduleOperationSchema` テスト作成
   - [ ] スキーマ実装
   - [ ] `BatchScheduleResultSchema` テスト作成
   - [ ] スキーマ実装

2. **Repository拡張**
   - [ ] `listByClientId` テスト作成
   - [ ] `listByClientId` 実装
   - [ ] `batchCreate` テスト作成
   - [ ] `batchCreate` 実装
   - [ ] `batchUpdate` テスト作成
   - [ ] `batchUpdate` 実装
   - [ ] `batchSoftDelete` テスト作成
   - [ ] `batchSoftDelete` 実装

3. **Service拡張**
   - [ ] `listByClientId` テスト作成
   - [ ] `listByClientId` 実装
   - [ ] `batchUpsert` テスト作成（正常系）
   - [ ] `batchUpsert` テスト作成（バリデーションエラー）
   - [ ] `batchUpsert` テスト作成（重複チェック）
   - [ ] `batchUpsert` 実装

4. **Server Action追加**
   - [ ] `listBasicSchedulesByClientAction` テスト作成
   - [ ] `listBasicSchedulesByClientAction` 実装
   - [ ] `batchUpsertBasicSchedulesAction` テスト作成
   - [ ] `batchUpsertBasicSchedulesAction` 実装

### Phase 2: 状態管理Hook（1-2時間）

5. **useScheduleReducer**
   - [ ] Reducer型定義作成
   - [ ] Reducer単体テスト作成（全アクション）
   - [ ] Reducer実装
   - [ ] Hook単体テスト作成
   - [ ] Hook実装

6. **useBeforeUnload**
   - [ ] テスト作成
   - [ ] 実装

### Phase 3: UIコンポーネント（3-4時間）

7. **WeeklyScheduleGrid**
   - [ ] Props型定義
   - [ ] Storybook作成（Empty, WithData, WithIndicators）
   - [ ] テスト作成
   - [ ] 実装

8. **ScheduleCard**
   - [ ] Storybook作成（各ステータス）
   - [ ] テスト作成
   - [ ] 実装

9. **ScheduleEntryForm**
   - [ ] Storybook作成（Create, Edit）
   - [ ] テスト作成（バリデーション）
   - [ ] 実装

10. **ClientScheduleEditor**
    - [ ] Storybook作成
    - [ ] 統合テスト作成
    - [ ] 実装

### Phase 4: ページ統合（1時間）

11. **ページ作成**
    - [ ] `/admin/basic-schedules/clients/[clientId]/edit/page.tsx` 作成
    - [ ] `/admin/basic-schedules/new/[clientId]/page.tsx` 作成
    - [ ] ナビゲーション追加

### Phase 5: リファクタリング・ドキュメント（1時間）

12. **既存コードとの整合性**
    - [ ] 既存 `BasicScheduleGrid` からのリンク追加
    - [ ] 利用者一覧からの導線追加

13. **ドキュメント更新**
    - [ ] `docs/screens/admin-basic-schedules-edit.md` 更新
    - [ ] `docs/features/basic-schedule.md` 更新

---

## テスト戦略

### ユニットテスト

| 対象                | テストファイル                    | カバー率目標 |
| ------------------- | --------------------------------- | ------------ |
| Reducer             | `reducer.test.ts`                 | 100%         |
| useScheduleReducer  | `useScheduleReducer.test.ts`      | 90%+         |
| useBeforeUnload     | `useBeforeUnload.test.ts`         | 90%+         |
| Service.batchUpsert | `basicScheduleService.test.ts`    | 90%+         |
| Repository.batch\*  | `basicScheduleRepository.test.ts` | 80%+         |

### コンポーネントテスト

| 対象                 | テスト観点                             |
| -------------------- | -------------------------------------- |
| WeeklyScheduleGrid   | 曜日表示、カード配置、空状態           |
| ScheduleCard         | ステータス別表示、クリックイベント     |
| ScheduleEntryForm    | バリデーション、送信、キャンセル       |
| ClientScheduleEditor | 追加→グリッド反映、編集→インジケーター |

### Storybookシナリオ

| Story              | 確認観点                           |
| ------------------ | ---------------------------------- |
| Empty              | 予定なし状態の表示                 |
| WithSchedules      | 既存データの表示                   |
| WithPendingChanges | 追加・変更インジケーター           |
| FormOpen           | フォームモーダル表示               |
| EditMode           | 編集フォーム（既存データ入力済み） |

### E2Eテスト（将来対応）

- 複数予定の追加→確定→DB保存
- 編集→キャンセル（変更破棄）
- ページ離脱時の警告ダイアログ

---

## 技術的考慮事項

### トランザクション整合性

Supabase ではネイティブトランザクションに制限があるため、以下のアプローチを採用：

1. **楽観的バッチ実行**: 一括 insert/update を順次実行
2. **部分失敗時の対応**: エラー詳細を返却し、UI で表示
3. **将来対応**: RPC 関数によるサーバーサイドトランザクション

```sql
-- 将来的に追加する RPC（必要な場合）
CREATE OR REPLACE FUNCTION batch_upsert_basic_schedules(...)
RETURNS json AS $$
BEGIN
  -- トランザクション内で実行
END;
$$ LANGUAGE plpgsql;
```

### パフォーマンス

- **初期ロード**: 利用者IDでフィルタして取得（N+1回避）
- **グリッド再描画**: React.memo で曜日セルをメモ化
- **差分検出**: 変更されたエントリのみ送信

### アクセシビリティ

- グリッドの各セルに適切な `aria-label`
- フォームモーダルのフォーカス管理
- キーボードナビゲーション対応

---

## 受け入れ条件との対応

| AC                                                 | 対応箇所                                 |
| -------------------------------------------------- | ---------------------------------------- |
| AC1: グリッド形式で1週間分スケジュールが表示される | `WeeklyScheduleGrid`                     |
| AC2: 新規追加でフォーム表示・グリッド追加          | `ScheduleEntryForm` + Reducer            |
| AC3: 追加・変更項目にインジケーター表示            | `ScheduleCard` の `status` prop          |
| AC4: 既存予定クリックで編集フォーム表示            | `ScheduleCard` + `OPEN_FORM` action      |
| AC5: まとめてDB保存                                | `batchUpsertBasicSchedulesAction`        |
| AC6: バリデーションエラー表示                      | `ScheduleEntryForm` + Service validation |
| AC7: 未保存変更時のページ離脱警告                  | `useBeforeUnload`                        |
| AC8: 既存機能に影響がない                          | 新規URLパス、既存コード変更最小化        |

---

## 見積もり

| Phase                     | 工数         |
| ------------------------- | ------------ |
| Phase 1: バックエンド拡張 | 2-3時間      |
| Phase 2: 状態管理Hook     | 1-2時間      |
| Phase 3: UIコンポーネント | 3-4時間      |
| Phase 4: ページ統合       | 1時間        |
| Phase 5: リファクタリング | 1時間        |
| **合計**                  | **8-11時間** |

---

## ブランチ

```bash
git checkout -b feature/issue-23-batch-schedule-editor
```

## 参考リンク

- [Issue #23](https://github.com/your-repo/issues/23)
- [react-hook-form 公式ドキュメント](https://react-hook-form.com/)
- [daisyUI モーダル](https://daisyui.com/components/modal/)
