# 実装計画: 統一アプリケーションヘッダーにログインユーザー名とドロップダウンメニューを追加

## 概要

**GitHub Issue**: [#7](https://github.com/ebi311/rhubarb/issues/7)  
**作成日**: 2026-02-04

# mockRepository.findById.mockResolvedValue(existingClient);\

Pull

---

## 要件サマリ

1. アプリ名「Rhubarb」をクリックしたらダッシュボード（`/`）に移動
2. ログインユーザー名をヘッダー右側に表示
3. ログイン者名をクリックしたらドロップダウンメニュー表示
4. ドロップダウンにログアウトオプション
5. ログアウトでセッション破棄してログイン画面（`/login`）に遷移

---

## ファイル構成

### 新規作成

```
src/app/_components/Header/
 UserMenu/
   ├── UserMenu.tsx           # Client Component (ドロップダウンメニュー)
   ├── UserMenu.test.tsx      # Vitest テスト
   ├── UserMenu.stories.tsx   # Storybook ストーリー
   └── index.ts               # named export
```

### 変更

```
src/app/_components/Header/
 Header.tsx           # Server Component → async に変更、ユーザー情報取得
 Header.test.tsx      # テスト更新
 Header.stories.tsx   # Storybook 更新
 index.ts             # 既存（変更なし）
```

---

## 技術設計

### 1. コンポーネント構成

```
Header (Server Component - async)
 Link (アプリ名 "Rhubarb" → /)
 UserMenu (Client Component)
    ├── ユーザー名表示ボタン
    └── Dropdown (daisyUI)
        └── ログアウトボタン (form + signOut action)
```

### 2. データフロー

```
Header (Server Component)
  ↓ createSupabaseClient()
  ↓ supabase.auth.getUser() → authUserId
  ↓ staffRepository.findByAuthUserId(authUserId) → Staff
  ↓ staff.name を UserMenu に props で渡す
UserMenu (Client Component)
  ↓ props.userName を表示
  ↓ ドロップダウン内で signOut を呼び出し
```

### 3. Header.tsx の実装方針

```tsx
// Server Component (async)
import Link from 'next/link';
import { createSupabaseClient } from '@/utils/supabase/server';
import { StaffRepository } from '@/backend/repositories/staffRepository';
import { UserMenu } from './UserMenu';

export async function Header() {
	const supabase = await createSupabaseClient();
	const {
		data: { user },
	} = await supabase.auth.getUser();

	let userName: string | null = null;
	if (user) {
		const staffRepository = new StaffRepository(supabase);
		const staff = await staffRepository.findByAuthUserId(user.id);
		userName = staff?.name ?? null;
	}

	return (
		<header className="navbar bg-base-100 shadow-sm">
			<div className="flex-1">
				<Link href="/" className="btn text-xl btn-ghost">
					Rhubarb
				</Link>
			</div>
			<div className="flex-none">
				{userName ? (
					<UserMenu userName={userName} />
				) : // 未ログイン時は何も表示しない、またはログインリンク
				null}
			</div>
		</header>
	);
}
```

### 4. UserMenu.tsx の実装方針

```tsx
'use client';

import { signOut } from '@/app/auth/actions';

type Props = {
	userName: string;
};

export function UserMenu({ userName }: Props) {
	return (
		<details className="dropdown dropdown-end">
			<summary className="btn btn-ghost">{userName}</summary>
			<ul className="dropdown-content menu z-10 w-52 rounded-box bg-base-100 p-2 shadow-sm">
				<li>
					<form action={signOut}>
						<button type="submit" className="w-full text-left">
							ログアウト
						</button>
					</form>
				</li>
			</ul>
		</details>
	);
}
```

### 5. daisyUI dropdown の使用

Issue の指定に従い、daisyUI の `dropdown` コンポーネントを使用：

```html
<details class="dropdown dropdown-end">
	<summary>Button</summary>
	<ul class="dropdown-content menu">
		{CONTENT}
	</ul>
</details>
```

- `dropdown-end`: ドロップダウンを右端揃えに配置
- `menu`: メニューリスト用スタイル
- `rounded-box`, `shadow-sm`: daisyUI 標準スタイル

### 6. レスポンシブ対応

- モバイルでもユーザー名が適切に表示されるよう `truncate` を考慮
- 必要に応じて `hidden sm:inline` でモバイルではアイコンのみ表示も検討

---

## 実装順序（TDD アプローチ）

### Phase 1: UserMenu コンポーネント（新規）

1. **テスト作成** (`UserMenu.test.tsx`)
   - ユーザー名が表示されること
   - ログアウトボタンが存在すること
   - ドロップダウンが適切なクラスを持つこと

2. **実装** (`UserMenu.tsx`)
   - `'use client'` ディレクティブ
   - Props: `userName: string`
   - daisyUI `dropdown` + `menu` を使用
   - `signOut` action をフォームで呼び出し

3. **Storybook** (`UserMenu.stories.tsx`)
   - Default: 通常のユーザー名
   - LongName: 長いユーザー名（truncate 確認）

4. **index.ts**
   - named export

### Phase 2: Header コンポーネント（変更）

1. **テスト更新** (`Header.test.tsx`)
   - アプリ名がリンクになっていること
   - リンク先が `/` であること
   - ユーザー名が渡された場合 UserMenu が表示されること
   - ※ async コンポーネントのため、モック戦略の調整が必要

2. **実装更新** (`Header.tsx`)
   - `async` 関数に変更
   - `Link` コンポーネントでアプリ名をラップ
   - Supabase から認証ユーザー情報を取得
   - `StaffRepository.findByAuthUserId()` でスタッフ名を取得
   - `UserMenu` を条件付きレンダリング

3. **Storybook 更新** (`Header.stories.tsx`)
   - モックで非同期処理を回避
   - ログイン状態 / 未ログイン状態のストーリー

---

## テスト戦略

### UserMenu.test.tsx

```tsx
import { render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { UserMenu } from './UserMenu';

vi.mock('@/app/auth/actions', () => ({
	signOut: vi.fn(),
}));

describe('UserMenu', () => {
	it('ユーザー名が表示される', () => {
		render(<UserMenu userName="田中 太郎" />);
		expect(screen.getByText('田中 太郎')).toBeInTheDocument();
	});

	it('ログアウトボタンが存在する', () => {
		render(<UserMenu userName="田中 太郎" />);
		expect(
			screen.getByRole('button', { name: 'ログアウト' }),
		).toBeInTheDocument();
	});

	it('ドロップダウンが dropdown-end クラスを持つ', () => {
		render(<UserMenu userName="田中 太郎" />);
		const dropdown = screen.getByRole('group'); // details 要素
		expect(dropdown).toHaveClass('dropdown-end');
	});
});
```

### Header.test.tsx（更新）

```tsx
import { render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { Header } from './Header';

// Mock dependencies
vi.mock('@/app/auth/actions', () => ({
	signOut: vi.fn(),
}));

vi.mock('@/utils/supabase/server', () => ({
	createSupabaseClient: vi.fn().mockResolvedValue({
		auth: {
			getUser: vi.fn().mockResolvedValue({
				data: { user: { id: 'user-123' } },
			}),
		},
		from: vi.fn(),
	}),
}));

vi.mock('@/backend/repositories/staffRepository', () => ({
	StaffRepository: vi.fn().mockImplementation(() => ({
		findByAuthUserId: vi.fn().mockResolvedValue({
			id: 'staff-1',
			name: '田中 太郎',
		}),
	})),
}));

describe('Header', () => {
	it('アプリ名がリンクとして表示される', async () => {
		render(await Header());
		const link = screen.getByRole('link', { name: 'Rhubarb' });
		expect(link).toBeInTheDocument();
		expect(link).toHaveAttribute('href', '/');
	});

	it('ログインユーザー名が表示される', async () => {
		render(await Header());
		expect(screen.getByText('田中 太郎')).toBeInTheDocument();
	});
});
```

---

## 受け入れ条件チェックリスト

- [ ] アプリ名「Rhubarb」をクリックすると `/` に遷移する
- [ ] ヘッダー右側にログイン中のスタッフ名が表示される
- [ ] スタッフ名をクリックするとドロップダウンメニューが開く
- [ ] ドロップダウン内に「ログアウト」ボタンがある
- [ ] ログアウトボタンをクリックするとセッションが破棄され、`/login` に遷移する
- [ ] ログインしていない状態（スタッフが見つからない場合）は適切にハンドリングされる
- [ ] テスト (Vitest) が追加/更新されている
- [ ] Storybook が追加/更新されている
- [ ] レスポンシブデザインに対応している

---

## 依存関係・使用する既存リソース

### 既存コード

- `signOut` (`src/app/auth/actions.ts`) - ログアウト処理
- `createSupabaseClient` (`src/utils/supabase/server.ts`) - Supabase クライアント作成
- `StaffRepository.findByAuthUserId()` (`src/backend/repositories/staffRepository.ts`) - スタッフ取得

### daisyUI コンポーネント

- `navbar` - ヘッダー全体
- `dropdown` (`dropdown-end`) - ユーザーメニュー
- `menu` - ドロップダウン内リスト
- `btn`, `btn-ghost` - ボタンスタイル

---

## 注意事項

1. **Server Component → Client Component 境界**
   - Header は Server Component（async）
   - UserMenu は Client Component（`'use client'`）
   - ユーザー名は props で渡す

2. **認証チェック**
   - middleware で認証チェック済みのため、Header では認証エラーは考慮しない
   - ただし、スタッフが見つからない場合のフォールバックは実装

3. **Storybook のモック**
   - async Server Component のため、`storybook/test` の `mocked` を使用
   - Supabase と Repository のモックが必要

---

## 作業ブランチ

```bash
git checkout -b feature/issue-7-header-user-menu
```
