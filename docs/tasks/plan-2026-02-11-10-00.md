# Issue #27: BasicScheduleForm を拡張し、ScheduleEditFormModal のユースケースをカバーする

## 概要

`ScheduleEditFormModal` と `BasicScheduleForm` は基本スケジュールのフォームとしてほぼ同じ機能を持つが、コードが重複している。`BasicScheduleForm` のほうがバリデーションが適切なため、`BasicScheduleForm` を拡張して `ScheduleEditFormModal` の用途もカバーし、コード重複を解消する。

## 修正履歴

### 2026-02-11 修正 (v2)

---

1. **非表示 → ReadOnly表示**: `fixedClientId`/`fixedWeekday` でフィールドを非表示ではなく、読み取り専用テキストで表示する
2. **onSubmitSuccess の呼び出し位置**: バリデーションとServerActionは共通で使用し、成功後に `onSubmitSuccess` コールバックを呼び出す
3. **BasicScheduleFormModal は作成しない**: `BasicScheduleForm` 自体を拡張してモーダル対応もする（重複回避）

---

## 現状分析

### 両コンポーネントの比較

| 観点           | BasicScheduleForm                | ScheduleEditFormModal                           |
| -------------- | -------------------------------- | ----------------------------------------------- |
| 表示形式       | ページ埋め込み（`<section>`）    | モーダルダイアログ                              |
| 利用者選択     | あり（新規利用者の追加も可能）   | なし（`clientId` は props で固定）              |
| 曜日選択       | あり                             | なし（`weekday` は props で固定）               |
| データ永続化   | サーバーアクションを直接呼び出し | `onSubmit` コールバックで `ScheduleData` を返す |
| モード         | `create` / `edit`                | 初期データ有無で判定                            |
| バリデーション | Zod（包括的）                    | Zod（基本的）                                   |
| 担当者選択     | `StaffPickerDialog` 使用         | `StaffPickerDialog` 使用                        |

### 使用箇所

#### BasicScheduleForm

- `/admin/basic-schedules/new` - 新規作成ページ
- `/admin/basic-schedules/[id]/edit` - 編集ページ

#### ScheduleEditFormModal

- `AddButton.tsx` - グリッドビューからの新規作成
- `ClientWeeklyScheduleEditor.tsx` - 利用者別編集画面

---

## 設計方針

### 新しい Props 構造

```typescript
export type BasicScheduleFormProps = {
	// 既存のプロパティ
	serviceUsers: ServiceUser[];
	serviceTypes: ServiceTypeOption[];
	staffs: StaffRecord[];
	initialValues?: BasicScheduleFormInitialValues;
	mode?: BasicScheduleFormMode;
	scheduleId?: string;

	// 新規追加
	/** clientId が固定の場合に指定。利用者選択フィールドを読み取り専用テキストで表示 */
	fixedClientId?: string;
	/** weekday が固定の場合に指定。曜日選択フィールドを読み取り専用テキストで表示 */
	fixedWeekday?: DayOfWeek;
	/** ServerAction 成功後のコールバック（ダイアログを閉じるなど） */
	onSubmitSuccess?: () => void;
	/** キャンセルボタンのコールバック（モーダル用） */
	onCancel?: () => void;
	/** コンテナ要素（section）を非表示にし、フォーム要素のみを表示（モーダル用） */
	asModal?: boolean;
};
```

### 動作モードの整理

| 条件                   | 動作                                                                       |
| ---------------------- | -------------------------------------------------------------------------- |
| `fixedClientId` あり   | 利用者選択フィールドの代わりに利用者名をテキスト表示（読み取り専用）       |
| `fixedWeekday` あり    | 曜日選択フィールドの代わりに曜日名をテキスト表示（読み取り専用）           |
| `onSubmitSuccess` あり | ServerAction 成功後に `onSubmitSuccess` を呼び出す（ダイアログ閉じるなど） |
| `asModal` あり         | `<section>` コンテナを省略、ヘッダーを省略（モーダル内で使用）             |
| `onCancel` あり        | キャンセルボタンを表示                                                     |

### ⚠️ 重要な設計判断

- **ServerAction は常に呼び出す**: `onSubmitSuccess` が指定されていても、バリデーションとServerActionは既存ロジックのまま実行
- **コールバックは成功後に呼び出す**: `handleActionResult` の `onSuccess` 内、または reset 後に `onSubmitSuccess?.()` を呼び出す
- **リダイレクトの制御**: `onSubmitSuccess` が指定されている場合は `router.push` をスキップ（親コンポーネントで制御）

---

## 実装計画

### Phase 1: BasicScheduleForm の Props 拡張（低リスク）

**目的**: 既存の動作を維持しながら、新しい props を追加

#### タスク 1.1: 型定義の追加

- [ ] `BasicScheduleFormProps` に新しい props を追加
  - `fixedClientId?: string`
  - `fixedWeekday?: DayOfWeek`
  - `onSubmitSuccess?: () => void`
  - `onCancel?: () => void`
  - `asModal?: boolean`

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.tsx`

---

#### タスク 1.2: ReadOnly表示コンポーネントの追加

**概要**: 固定値がある場合に読み取り専用テキストで表示するコンポーネントを追加

```tsx
// ClientReadOnlyField - fixedClientId がある場合に表示
export const ClientReadOnlyField = ({ clientName }: { clientName: string }) => (
	<fieldset className="fieldset">
		<legend className="fieldset-legend">利用者</legend>
		<div className="input flex items-center input-ghost bg-base-200">
			{clientName}
		</div>
	</fieldset>
);

// WeekdayReadOnlyField - fixedWeekday がある場合に表示
export const WeekdayReadOnlyField = ({ weekday }: { weekday: DayOfWeek }) => (
	<fieldset className="fieldset">
		<legend className="fieldset-legend">曜日</legend>
		<div className="input flex items-center input-ghost bg-base-200">
			{WEEKDAY_FULL_LABELS[weekday]}
		</div>
	</fieldset>
);
```

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleForm/FormControls.tsx`

---

#### タスク 1.3: useBasicScheduleFormSubmit のコールバック対応

**概要**: `onSubmitSuccess` パラメータを追加し、成功後に呼び出す

**変更内容**:

1. `UseBasicScheduleFormSubmitParams` に `onSubmitSuccess?: () => void` を追加
2. `onSubmit` 関数内の成功処理を修正:
   - `onSubmitSuccess` がある場合: `reset()` → `closeStaffPicker()` → `onSubmitSuccess()` を呼び出し、リダイレクトをスキップ
   - `onSubmitSuccess` がない場合: 従来通り `router.push('/admin/basic-schedules')` を実行

```typescript
// 修正イメージ
if (!handled) {
	setApiError(result.error ?? '不明なエラーが発生しました');
	return;
}

reset(buildDefaultValues(initialValues));
closeStaffPicker();

if (onSubmitSuccess) {
	onSubmitSuccess();
} else {
	router.push('/admin/basic-schedules');
}
```

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleForm/useBasicScheduleFormSubmit.ts`

---

#### タスク 1.4: BasicScheduleForm のレンダリング対応

**概要**: 新しい props に基づいて条件付きレンダリングを実装

**変更内容**:

1. `fixedClientId` がある場合:
   - `ClientSelectField` の代わりに `ClientReadOnlyField` を表示
   - `serviceUsers` から該当する利用者名を取得して表示
   - formの `clientId` に `fixedClientId` を設定

2. `fixedWeekday` がある場合:
   - `WeekdayField` の代わりに `WeekdayReadOnlyField` を表示
   - formの `weekday` に `fixedWeekday` を設定

3. `asModal` がある場合:
   - `<section>` コンテナを省略
   - ヘッダー（タイトル）を省略

4. `onCancel` がある場合:
   - キャンセルボタンを表示

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.tsx`

---

#### タスク 1.5: テストとStorybookの更新

- [ ] 新しい props を使用したテストケースを追加
  - `fixedClientId` 使用時の読み取り専用表示
  - `fixedWeekday` 使用時の読み取り専用表示
  - `onSubmitSuccess` のコールバック呼び出し
  - `asModal` 使用時のレンダリング
  - `onCancel` 使用時のキャンセルボタン表示
- [ ] 新しい stories を追加

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.test.tsx`
- `src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.stories.tsx`

---

### Phase 2: AddButton の移行

**目的**: グリッドビューの追加ボタンを新しい `BasicScheduleForm` に移行

#### タスク 2.1: AddButton の更新

- [ ] `ScheduleEditFormModal` → daisyUI `modal` + `BasicScheduleForm` に変更
- [ ] props の変換:
  - `staffOptions` → `staffs`
  - `serviceTypeOptions` → `serviceTypes`
  - `weekday` → `fixedWeekday`
  - `onClose` → `onCancel`
  - サーバーへのコミット時: `onSubmit` → `onSubmitSuccess`（ダイアログを閉じる）
- [ ] テストの更新

**変更イメージ**:

```tsx
<dialog className="modal" open={isOpen}>
	<div className="modal-box">
		<h3 className="text-lg font-bold">スケジュール追加</h3>
		<BasicScheduleForm
			serviceUsers={serviceUsers}
			serviceTypes={serviceTypes}
			staffs={staffs}
			fixedClientId={clientId}
			fixedWeekday={weekday}
			asModal
			onSubmitSuccess={() => {
				handleClose();
				// 必要に応じてデータ再取得
			}}
			onCancel={handleClose}
		/>
	</div>
	<form method="dialog" className="modal-backdrop">
		<button onClick={handleClose}>close</button>
	</form>
</dialog>
```

**ファイル**:

- `src/app/admin/basic-schedules/_components/BasicScheduleGrid/AddButton.tsx`
- `src/app/admin/basic-schedules/_components/BasicScheduleGrid/AddButton.test.tsx`

---

### Phase 3: ClientWeeklyScheduleEditor の移行

**目的**: 利用者別編集画面を新しい `BasicScheduleForm` に移行

#### タスク 3.1: ClientWeeklyScheduleEditor の更新

- [ ] `ScheduleEditFormModal` → daisyUI `modal` + `BasicScheduleForm` に変更
- [ ] props の変換処理を追加
- [ ] テストの更新

**ファイル**:

- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ClientWeeklyScheduleEditor/ClientWeeklyScheduleEditor.tsx`
- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ClientWeeklyScheduleEditor/ClientWeeklyScheduleEditor.test.tsx`

---

### Phase 4: 型参照の移行

**目的**: `ScheduleEditFormModalProps` の型参照を新しい型に移行

#### タスク 4.1: 型参照の更新

- [ ] `page.tsx` の型参照を更新（`ServiceTypeOption`, `StaffPickerOption` のインポート元変更）
- [ ] `BasicScheduleContent.tsx` の型参照を更新
- [ ] `BasicScheduleContent.test.tsx` の型参照を更新

**ファイル**:

- `src/app/admin/basic-schedules/page.tsx`
- `src/app/admin/basic-schedules/_components/BasicScheduleContent/BasicScheduleContent.tsx`
- `src/app/admin/basic-schedules/_components/BasicScheduleContent/BasicScheduleContent.test.tsx`

---

### Phase 5: ScheduleEditFormModal の削除

**目的**: 不要になったコンポーネントを削除

#### タスク 5.1: ファイル削除

- [ ] `ScheduleEditFormModal` 関連ファイルを削除

**削除対象**:

- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/ScheduleEditFormModal.tsx`
- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/ScheduleEditFormModal.test.tsx`
- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/ScheduleEditFormModal.stories.tsx`
- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/ScheduleFormFields.tsx`
- `src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/index.ts`

---

## 既存使用箇所への影響確認

### 影響なし（既存の動作を維持）

- `/admin/basic-schedules/new` - 新規作成ページ
- `/admin/basic-schedules/[id]/edit` - 編集ページ

props はすべてオプショナルであり、既存の呼び出し元は変更不要。

### 影響あり（移行が必要）

- `AddButton.tsx` - Phase 2 で移行
- `ClientWeeklyScheduleEditor.tsx` - Phase 3 で移行
- `page.tsx`, `BasicScheduleContent.tsx` - Phase 4 で型参照を更新

---

## リスクと軽減策

| リスク                               | 軽減策                                   |
| ------------------------------------ | ---------------------------------------- |
| 既存ページの動作が壊れる             | Phase 1 完了後に既存ページのテストを実行 |
| 固定値が正しくフォームに反映されない | `useEffect` で初期値を設定、テストで確認 |
| リダイレクトの制御が複雑になる       | `onSubmitSuccess` の有無で分岐を明確化   |

---

## 完了条件

- [ ] `BasicScheduleForm` が新しい props に対応
  - [ ] `fixedClientId` で利用者名を読み取り専用テキスト表示
  - [ ] `fixedWeekday` で曜日名を読み取り専用テキスト表示
  - [ ] `onSubmitSuccess` で成功後コールバック
  - [ ] `onCancel` でキャンセルボタン表示
  - [ ] `asModal` でモーダル用レイアウト
- [ ] `AddButton` が `BasicScheduleForm` を使用するように変更
- [ ] `ClientWeeklyScheduleEditor` が `BasicScheduleForm` を使用するように変更
- [ ] 既存の新規作成/編集ページが正常に動作
- [ ] `ScheduleEditFormModal` と関連ファイルが削除
- [ ] すべてのテストがパス
- [ ] Storybook のビルドがパス

---

## テスト計画

### ユニットテスト

- BasicScheduleForm: 新しい props のテスト
  - `fixedClientId` 使用時に利用者名がテキスト表示されること
  - `fixedWeekday` 使用時に曜日名がテキスト表示されること
  - `onSubmitSuccess` が成功時に呼び出されること
  - `asModal` 使用時にヘッダーが省略されること
  - `onCancel` 使用時にキャンセルボタンが表示されること
- AddButton: 移行後の動作テスト
- ClientWeeklyScheduleEditor: 移行後の動作テスト

### 手動テスト

1. 新規作成ページ (`/admin/basic-schedules/new`) で新規スケジュールを作成
2. 編集ページ (`/admin/basic-schedules/[id]/edit`) でスケジュールを編集・削除
3. グリッドビューの追加ボタンからスケジュールを追加
4. 利用者別編集画面でスケジュールを追加・編集・削除

---

## 推定作業時間

| Phase    | 推定時間    |
| -------- | ----------- |
| Phase 1  | 2-3時間     |
| Phase 2  | 1時間       |
| Phase 3  | 1時間       |
| Phase 4  | 30分        |
| Phase 5  | 15分        |
| **合計** | **5-6時間** |

---

## 参考リンク

- [GitHub Issue #27](https://github.com/ebi311/rhubarb/issues/27)
- [BasicScheduleForm.tsx](src/app/admin/basic-schedules/_components/BasicScheduleForm/BasicScheduleForm.tsx)
- [ScheduleEditFormModal.tsx](src/app/admin/basic-schedules/clients/[clientId]/edit/_components/ScheduleEditFormModal/ScheduleEditFormModal.tsx)
- [AddButton.tsx](src/app/admin/basic-schedules/_components/BasicScheduleGrid/AddButton.tsx)
