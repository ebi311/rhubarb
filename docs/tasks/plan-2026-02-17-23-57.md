# Issue #35 実装計画: 今日スケジュールをグリッド表示へ（06:00〜翌06:00）

- Issue: https://github.com/ebi311/rhubarb/issues/35
- ブランチ: `feature/issue-35-today-schedule-grid`
- 作成日: 2026-02-17

## ゴール / 受け入れ条件

- 表示範囲が **06:00〜翌06:00** の「今日のスケジュール」になっている
- **30分ごとの横線**（罫線）が表示される
- **未割り当てシフト**はシフトボックス上に daisyUI `indicator` で **「未割当」**（`badge badge-warning`）を表示する
- シフトが無い場合は空表示（「今日の予定はありません」相当）
- UT / Storybook が更新され、CI（`pnpm test:ut --run` / storybook test）に耐える

## 変更点サマリー（現状把握）

### 現状

- データ取得
  - [src/app/actions/dashboard.ts](src/app/actions/dashboard.ts)
  - [src/backend/services/dashboardService.ts](src/backend/services/dashboardService.ts)
  - [src/backend/repositories/shiftRepository.ts](src/backend/repositories/shiftRepository.ts)
- 表示
  - [src/app/\_components/DashboardTimeline/DashboardTimeline.tsx](src/app/_components/DashboardTimeline/DashboardTimeline.tsx)
- `getTodayTimeline()` は暦日フィルタ（00:00〜23:59）で取得し、縦型タイムライン（daisyUI `timeline`）で表示

### 目標

- 取得条件を「**06:00〜翌06:00**」の日時レンジに変更
- 表示を「**縦=時刻 / 横=スタッフ**」のグリッドに変更

## 仕様の確認ポイント（要確認/前提）

- A案（推奨・実装が自然）: 横軸に「スタッフ + 未割当（疑似スタッフ列）」を含める
  - ただし、仕様変更コメントで「未割当列を設けない」意図がある場合は不適
- B案: 未割当は「全スタッフ列に属さない」ため、専用の"未割当レーン"を別枠で重ねる/表示する
  - UIが複雑になりやすい

**A案（未割当も1列として表示し、さらに indicator バッジで目立たせる）** を一旦の前提とする。

## フェーズ分割（5ファイル超の変更見込み）

Server Action / Service / Repository / UI / UT / Storybook に跨るため、レビュー容易性とTDDのためにフェーズ分割する。

### Phase 1（バックエンド）: 06:00〜翌06:00 の取得レンジ化

#### 対象ファイル

- [src/backend/repositories/shiftRepository.ts](src/backend/repositories/shiftRepository.ts)
- [src/backend/services/dashboardService.ts](src/backend/services/dashboardService.ts)
- [src/backend/services/dashboardService.test.ts](src/backend/services/dashboardService.test.ts)

#### 方針

- `ShiftFilters` に「日時レンジ」フィルタを追加し、既存の `startDate/endDate`（暦日）と共存させる
  - 例: `startDateTime?: Date`, `endDateTime?: Date`
  - 既存利用箇所は壊さない（後方互換）
- `DashboardService.getTodayTimeline()` は `today` から JST 06:00 の `rangeStart` と翌日06:00の `rangeEnd` を作り、
  - `shiftRepo.list({ officeId, startDateTime: rangeStart, endDateTime: rangeEnd })` で取得
  - 並び順は「06:00起点の24h」順（深夜帯が末尾に来る）

#### 重要な細部

- `endDateTime` は **排他的（`lt`）** で扱う（翌日06:00ちょうど開始のシフトは次日の枠に含めたい）
- JST起点の算出は既存ユーティリティを利用
  - `setJstTime(date, hours, minutes)`
  - `addJstDays(date, 1)`
- 深夜跨ぎの表示順・長さ計算に備えて、サービス側のソートキーは次のロジックを採用
  - `minutesFromMidnight = hour*60 + minute`
  - `absMinutes = minutesFromMidnight + (minutesFromMidnight < 360 ? 1440 : 0)`
  - ソートキーは `absMinutes`（06:00=360を境に翌日分が末尾に来る）

#### TDD（先に落ちるテストを書く）

1. `dashboardService.test.ts` に追加ケース
   - 06:00より前（例: 02:00）のシフトが **配列の後ろ** に来る（ソート順の保証）
   - `shiftRepo.list` が `startDateTime/endDateTime` で呼ばれる
2. 実装
   - `ShiftFilters` 拡張 + `ShiftRepository.list()` で `gte/lt` を適用
   - `DashboardService.getTodayTimeline()` のレンジ化 & 新ソート
3. 既存テストの修正

---

### Phase 2（フロント）: グリッドUI（縦=時刻、横=スタッフ）

#### 対象ファイル

- [src/app/\_components/DashboardTimeline/DashboardTimeline.tsx](src/app/_components/DashboardTimeline/DashboardTimeline.tsx)
- 参考: [src/app/admin/weekly-schedules/\_components/WeeklyShiftGrid/StaffWeeklyShiftGrid.tsx](src/app/admin/weekly-schedules/_components/WeeklyShiftGrid/StaffWeeklyShiftGrid.tsx)

#### UI設計（最小実装）

- 06:00〜翌06:00 を 30分スロットで割り、全体高さを固定スケール（例: 1スロット=24px 等）
- レイアウトは「ヘッダー行（スタッフ名）」+「本文（24h縦スクロール可能）」
- 各スタッフ列は相対配置コンテナにし、シフトボックスは absolute で配置
  - `top = (startAbsMinutes - 360) * pxPerMinute`
  - `height = (endAbsMinutes - startAbsMinutes) * pxPerMinute`
- 30分罫線
  - 背景に `repeating-linear-gradient` で描く、または 48本の仕切り線をDOMで生成（どちらも Tailwind/daisyUI の範囲）
  - まずはDOM生成（実装が読みやすく、テーマ色も `border-base-300` 等で統一しやすい）

#### 未割当 indicator

- シフトボックスは
  - 通常: `div`（もしくは `card` 風の `rounded` + `bg-base-100` + `border`）
  - 未割当: daisyUI `indicator` で包み、
    - `indicator-item badge badge-warning` に `未割当`

```html
<div class="indicator">
	<span class="indicator-item badge badge-warning">未割当</span>
	<div class="card">...</div>
</div>
```

#### “スタッフ列”の決定

- 前提（A案）: `timeline` からユニークなスタッフ名を抽出し、`未割当`（`staffName=null`）を別列にする
  - シフトが0件のスタッフ列は出ない（必要なら別途 `staffs` をデータ側で返す拡張が必要）

---

### Phase 3（品質）: UT / Storybook 更新

#### 対象ファイル

- [src/app/\_components/DashboardTimeline/DashboardTimeline.test.tsx](src/app/_components/DashboardTimeline/DashboardTimeline.test.tsx)
- [src/app/\_components/DashboardTimeline/DashboardTimeline.stories.tsx](src/app/_components/DashboardTimeline/DashboardTimeline.stories.tsx)

#### UT 更新方針

- グリッド化でDOM構造が大きく変わるので、**表示要件に紐づくテスト**だけを残す
  - ヘッダー文言「今日のスケジュール」
  - 空状態「今日の予定はありません」
  - 未割当の indicator（`badge-warning` かつ「未割当」テキストが indicator-item 内にある）
  - 30分罫線は実装依存になりやすいので、UTでは「スロットが期待数（48）ある」等の弱い検証に留める（過剰に厳密にしない）

#### Storybook 更新方針

- `Default / WithUnassigned / Empty / SingleItem` を維持しつつ、
  - 深夜帯（例: 23:30-00:30、02:00-03:00）を含むサンプルを追加して見た目検証できるようにする

---

## 実装タスク詳細（チェックリスト）

- [ ] `ShiftFilters` に `startDateTime/endDateTime` を追加
- [ ] `ShiftRepository.list()` に日時レンジフィルタを追加（`gte(start_time)`, `lt(start_time)`）
- [ ] `DashboardService.getTodayTimeline()` を 06:00〜翌06:00 に変更
- [ ] `DashboardService.getTodayTimeline()` のソートを 06:00起点に修正
- [ ] `dashboardService.test.ts` をTDDで追加/修正
- [ ] `DashboardTimeline` をグリッドUIに刷新（30分罫線、staff列、絶対配置）
- [ ] 未割当に `indicator` バッジ（`badge badge-warning`）
- [ ] `DashboardTimeline.test.tsx` 更新
- [ ] `DashboardTimeline.stories.tsx` 更新（深夜ケース追加）

## テスト/検証

- UT: `pnpm test:ut --run`
- Storybook: `pnpm test:storybook --run`
- 手動: ダッシュボードで 06:00〜翌06:00 の枠、深夜シフト、未割当バッジ、空状態を確認

## リスクと対策

- 日跨ぎシフト（23:30-00:30 等）の扱い
  - 対策: “絶対分”計算（`endAbs <= startAbs` のとき `endAbs += 1440`）を利用
- 未割当の配置仕様が未確定
  - 対策: 実装前にA/Bを確定し、必要なら Phase 2 を調整
- スタッフ列を全員出す必要が出た場合
  - 対策: `DashboardData` に `staffs` を追加する別Issue/別フェーズに切り出す（影響が広い）
